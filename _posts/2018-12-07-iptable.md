# iptable 顺序

http://www.nfvschool.cn/?p=259

#### 首先我们来看一下目的是本机的报文，在被实际送到最终的应用程序前，它会通过如下的步骤

```
1.                     到了接口上（例如eth0）
2.raw       PREROUTING 这个链在连接跟踪之前处理报文，它能够设置一条连接不被连接跟踪处理。
3.                     这儿是连接跟踪处理的点
4.mangle    PREROUTING 这个链主要用来修改报文，例如修改TOS等等。
5.nat       PREROUTING 这个链主要用来处理DNAT，我们应该避免在这条链里面做过滤，因为可能有一些报文会漏掉。
6.                     路由决定，例如决定报文是上本机还是转发或者其他地方。
7.mangle    INPUT      到了这点，mangle表的INPUT链被使用，在把这个报文实际送给本机前，路由之后，我们需要再次修改报文。
8.filter    INPUT      在这儿我们对所有送往本机的报文进行过滤，要注意所有收到的并且目的地址为本机的报文都会经过这个链，而不管哪个接口进来的或者它往哪儿去。
10. 本地进程或者应用程序，例如服务器或者客户端程序。
```

下面我们在看看源地址是本机的报文，要经过哪些步骤
```
1.                   本地进程或者应用程序
2.                   路由选择，用哪个源地址以及从哪个接口上出去，当然还有其他一些必要的信息。
3.raw     OUTPUT     这儿是你能够在连接跟踪生效前处理报文的点，这儿你可以标记某个连接不被连接跟踪处理。
4.                   这儿就是本地发出报文进行连接跟踪处理的地儿。
5.mangle  OUTPUT     这儿是我们修改报文的地方，在这儿做报文过滤是不被推荐的，因为它可能有副作用。
6.nat     OUTPUT     这儿对于本级发送的报文做目的NAT（DNAT）
7.filter  OUTPUT     这儿是对发送报文做过滤的地方。
8.                   路由决定，因为前面的mangle和nat表可能修改了报文的路由信息。
9.mangle POSTROUTING 这条链可能被两种报文遍历，一种是转发的报文，另外就是本级产生的报文。
10.nat   POSTROUTING 在这儿我们做源NAT（SNAT），我们建议你不要在这儿做报文过滤，因为有副作用。即使你设置了默认策略，一些报文也有可能溜过去。
11.                  在接口上发出（例如eth0）。
```

下面的例子我们假设报文的目的地址是另外一个网络，要经过哪些步骤：
```
                      到了接口（例如eth0）
1.raw     PREROUTING  在这儿你可以设置不想被连接跟踪系统处理的连接。
2.                    这儿做的是非本地报文的连接跟踪系统处理
3.mangle  PREROUTING  这条链主要用来修改报文，例如改变TOS等等。
4.nat     PREROUTING  这条链主要完成DNAT，SNAT后面处理。在这条链上面不要做报文过滤。
5.                    路由决定，例如转发报文还是上送本机
6.mangle  FORWARD     包继续被发送至mangle表的FORWARD链，这是非常特殊的情况才会用到的。
7.filter  FORWARD     只有转发报文才会到这儿，因此这儿我们做所有报文的过滤。
8.                    路由决定，因为前面的mangle和nat表可能修改了报文的路由信息。
10.mangle POSTROUTING 这一步mangle是在所有更改包的目的地址的操作完成之后做的，但这时包还在本地上。
11. nat   POSTROUTING 这个链只能作为SNAT作用，千万不要做报文过滤，伪装（Masquerading）也是在这儿工作的。
12. 到了报文的出接口（例如eth1）。
```
